#!/usr/bin/env ruby
$:.unshift File.expand_path('../../lib', __FILE__)

require 'rubygems' unless Object.const_defined?(:Gem)
require 'van_helsing'
require 'rake'

# Intercept: if invoked as 'vh --help', don't let it pass through Rake, or else
# we'll see the Rake help screen. Redirect it to 'vh help'.
if ARGV.delete('--help') || ARGV.delete('-h')
  ARGV << 'help'
end

if ARGV.delete('--version') || ARGV.delete('-V')
  puts "Van Helsing, version v#{VanHelsing.version}"
  exit
end

if ARGV.delete('--simulate')
  ENV['simulate'] = '1'
end

scope = self

Rake.application.instance_eval do
  standard_exception_handling do
    # Initialize Rake and make it think it's Van Helsing.
    init 'vh'
    @rakefiles = ['Vhfile', 'config/deploy.rb']

    # Workaround: Rake 0.9+ doesn't record task descriptions unless it's needed.
    # Need it for 'vh help'
    if Rake::TaskManager.respond_to?(:record_task_metadata)
      Rake::TaskManager.record_task_metadata = true
    end

    # Load the Van Helsing Rake DSL.
    require 'van_helsing/rake'

    # Load the DSL that's relevant to deployment if you have a deploy.rb file.
    if have_rakefile
      require 'van_helsing/deploy'
      load_rakefile
    end

    # Run.
    top_level

    scope.vh_cleanup! if top_level_tasks.any?
  end
end

